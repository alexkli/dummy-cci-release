#
# ADOBE CONFIDENTIAL
# __________________
#
# Copyright 2019 Adobe Systems Incorporated
# All Rights Reserved.
#
# NOTICE:  All information contained herein is, and remains
# the property of Adobe Systems Incorporated and its suppliers,
# if any.  The intellectual and technical concepts contained
# herein are proprietary to Adobe Systems Incorporated and its
# suppliers and are protected by trade secret or copyright law.
# Dissemination of this information or reproduction of this material
# is strictly forbidden unless prior written permission is obtained
# from Adobe Systems Incorporated.
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#

ssh_keys: &ssh_keys
  add_ssh_keys:
    fingerprints:
      - "98:db:59:8c:95:ec:31:3b:ad:d4:8e:a7:c5:6d:57:8f"

test_results_build: &test_results_build
  # Unit-Test-reports for modules without action folder
  store_test_results:
    path: build
test_results_ac_build: &test_results_ac_build
  # Test-reports for modules with action folder
  store_test_results:
    path: action/build
test_logs_ac_bld: &test_logs_ac_bld
  # Test-logs for modules with action folder
  store_artifacts:
    path: action/build
    destination: build
test_logs_bld: &test_logs_bld
  # Test-logs for modules without action folder
  store_artifacts:
    path: build
    destination: build  
test_logs_ac_nui: &test_logs_ac_nui
  # Test-logs for modules with action folder for image comparision
  store_artifacts:
    path: action/.nui
    destination: .nui
coverage: &coverage
  # Coverage-report
  store_artifacts:
    path: coverage
    destination: coverage

version: 2

commands:
  artifactory_login: &artifactory_login
    run:
      name: Artifactory credentials setup
      command: |
        curl --fail -s -u${ARTIFACTORY_USER}:${ARTIFACTORY_TOKEN} https://artifactory.corp.adobe.com/artifactory/api/npm/npm-nui-release-local/auth/nui >> ~/.npmrc
        # this was added only for core repo
        curl --fail -s -u${ARTIFACTORY_USER}:${ARTIFACTORY_TOKEN} https://artifactory.corp.adobe.com/artifactory/api/npm/npm-aem-desktop-release-local/auth/aem-desktop >> ~/.npmrc

jobs:
  build_runtime:
    working_directory: ~/repo
    docker:
      - image: circleci/node:12.0.0
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - *ssh_keys
      - *artifactory_login
      - run:
          name: Creating Docker Runtime
          command: |
            mkdir -p ~/cache/docker_runtime
            if [ -d "docker" ] || [  -d "runtime" ]; then
              if [ -d "docker" ]; then
                cd ~/repo/docker
              elif [ -d "runtime" ]; then
                cd ~/repo/runtime
              fi
              if [ -f "download-artifacts" ]; then
                  export ARTIFACTORY_APIKEY=$ARTIFACTORY_TOKEN
                  ./download-artifacts
              fi
              docker login docker-project-nui-snapshot.dr.corp.adobe.com -u $ARTIFACTORY_USER -p $ARTIFACTORY_TOKEN
              export DOCKER_REGISTRY=docker-senseiwins-release.dr-uw2.adobeitc.com/
              if [ -f "docker-compose.yml" ]; then
                docker-compose build runtime
                docker image ls
                imgName=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "$CIRCLE_PROJECT_REPONAME")
                echo $imgName
                docker save -o ~/cache/docker_runtime/$CIRCLE_PROJECT_REPONAME.tar $imgName
                ls ~/cache/docker_runtime
              fi
            else
              cd ~/repo
              docker login docker-senseiwins-release.dr-uw2.adobeitc.com -u $ARTIFACTORY_UW2_USER -p $ARTIFACTORY_UW2_TOKEN
            fi
      - persist_to_workspace:
          root: /home/circleci/cache/
          paths:
            - docker_runtime

  build:
    working_directory: ~/repo
    machine:
        enabled: true
        docker_layer_caching: true
    steps:
      - checkout:
          path: ~/repo
      - *artifactory_login
      - attach_workspace:
          at: cache
      - run:
          name: Credentials and setup
          command: |
            docker login -u $ARTIFACTORY_UW2_USER -p $ARTIFACTORY_UW2_TOKEN docker-senseiwins-release.dr-uw2.adobeitc.com
            docker login docker-project-nui-snapshot.dr.corp.adobe.com -u $ARTIFACTORY_USER -p $ARTIFACTORY_TOKEN
      - run:
          name: Load Docker Runtime
          command: |
            if [ -d "docker" ] || [  -d "runtime" ]; then
              FILE=cache/docker_runtime/$CIRCLE_PROJECT_REPONAME.tar
              if [ -f $FILE ]; then
                docker load -i $FILE
              fi
            else
              cd ~/repo
              docker login docker-senseiwins-release.dr-uw2.adobeitc.com -u $ARTIFACTORY_UW2_USER -p $ARTIFACTORY_UW2_TOKEN
            fi
      - run:
          name: Run npm tests
          command: |
            cd ~/repo
            if [ -d "action" ]; then
                cd ~/repo/action
            fi
            # circleci user is missing write access to /usr/local/lib/node_modules
            sudo chown -R circleci /usr/local/
            chmod -R u+x+w /usr/local/
            export NVM_DIR="/opt/circleci/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm install v10.16.3
            nvm alias default v10.16.3
            npm install -g @nui/cli              
            npm install              
            npm test
      - *test_results_build
      - *test_results_ac_build
      - *test_logs_ac_bld
      - *test_logs_bld
      - *test_logs_ac_nui
      - *coverage


            
  release:
    docker:
      - image: circleci/node:12.0.0
    steps:
      - checkout
      - *ssh_keys
      - *artifactory_login
      - run:
          name: Echo Release
          command: |
            export NPM_TOKEN=$ARTIFACTORY_TOKEN
            export GH_TOKEN=$MY_GIT_TOKEN
            #export GITHUB_URL="https://git.corp.adobe.com/nui/$CIRCLE_PROJECT_REPONAME"
            #export GITHUB_PREFIX=$GITHUB_API
            echo "Getting ready to release!!"
            # printenv | sed 's;=.*;;' | sort
            npm install
            npx semantic-release
            #cd ~
            #git clone git@git.corp.adobe.com:nui/infra.git
            #~/infra/scripts/nui-release.sh


  validate_config:
    working_directory: ~/validate
    docker:
      - image: circleci/node:12.0.0
    steps:
      - checkout:
          path: ~/validate/repo
      - run:
          name: compare with central cci config
          command: |
            cd ~/validate
            git clone git@git.corp.adobe.com:nui/circleci.git
            # git clone https://$GITHUB_TOKEN@git.corp.adobe.com/circleci.git
            cd circleci
            git checkout $CIRCLE_BRANCH
            git branch
            #comparing ~/validate/repo/.circleci/config.yml to ~/validate/circleci/config.yml
            cmp -s ~/validate/repo/.circleci/config.yml ~/validate/circleci/config.yml || { echo 'circleci/config.yml not in sync'; exit 1; }

# validate_config job currently not used
workflows:
    version: 2
    build:
        jobs:
        - build_runtime:
            context: nui
        - build:
            context: nui
        - release:
            requires:
              - build_runtime
              - build
            filters:
              branches:
                only: master
            context: nui
  #        - validate_config:
  #            context: nui